name: ESP32 CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build_and_analyze:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:release-v5.4
      options: --user root

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          apt-get update
          apt-get install -y cppcheck jq

      - name: Source ESP-IDF
        run: . /opt/esp/idf/export.sh

      - name: Build (generate compile_commands.json)
        run: |
          idf.py set-target esp32s3
          idf.py fullclean
          idf.py build -D CMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Filter compile_commands.json (project code only)
        run: |
          jq '[.[] | select(
                (.file | startswith("main/")) or
                (.file | startswith("components/bsp/")) or
                (.file | startswith("components/common/")) or
                (.file | startswith("components/device_service/")) or
                (.file | startswith("components/drivers/")) or
                (.file | startswith("components/swc/"))
              )]' \
            build/compile_commands.json > build/compile_commands_mycode.json

      - name: Run cppcheck
        run: |
          cppcheck \
            --enable=all \
            --inconclusive \
            --std=c11 \
            --project=build/compile_commands_mycode.json \
            --error-exitcode=1
